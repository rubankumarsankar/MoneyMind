generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  Int                 @id @default(autoincrement())
  userId              String              @unique
  email               String              @unique
  password            String?
  name                String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  role                String              @default("USER")
  salaryDate          Int?
  onboardingCompleted Boolean             @default(false)
  isActive            Boolean             @default(true)
  accounts            Account[]
  borrows             Borrow[]
  budgets             Budget[]
  categories          Category[]
  creditCards         CreditCard[]
  dailyExpenses       DailyExpense[]
  emis                EMI[]
  financialSnapshots  FinancialSnapshot[]
  fixedExpenses       FixedExpense[]
  incomes             Income[]
  investments         Investment[]
  notifications       Notification[]
  recurringExpenses   RecurringExpense[]
  savings             Saving[]
  rules               CategoryRule[]
}

model Category {
  id        Int      @id @default(autoincrement())
  name      String
  type      String
  icon      String?
  color     String?
  userId    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name, type])
}

model Income {
  id        Int      @id @default(autoincrement())
  amount    Float
  source    String
  date      DateTime @default(now())
  accountId Int?
  userId    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  account   Account? @relation(fields: [accountId], references: [id])
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model FixedExpense {
  id         Int      @id @default(autoincrement())
  title      String
  name       String?
  category   String?
  amount     Float
  dayOfMonth Int
  accountId  Int?
  userId     Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  account    Account? @relation(fields: [accountId], references: [id])
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model DailyExpense {
  id            Int          @id @default(autoincrement())
  category      String
  amount        Float
  date          DateTime     @default(now())
  note          String?
  isAnomaly     Boolean      @default(false)
  paymentMethod String       @default("CASH")
  accountId     Int?
  creditCardId  Int?
  userId        Int
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  creditSpend   CreditSpend?
  account       Account?     @relation(fields: [accountId], references: [id])
  creditCard    CreditCard?  @relation(fields: [creditCardId], references: [id])
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model EMI {
  id            Int      @id @default(autoincrement())
  name          String
  totalAmount   Float
  interestRate  Float?
  monthlyAmount Float
  totalMonths   Int
  paidMonths    Int      @default(0)
  startDate     DateTime
  userId        Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CreditCard {
  id            Int            @id @default(autoincrement())
  name          String
  limit         Float
  billingDay    Int
  userId        Int
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  spends        CreditSpend[]
  dailyExpenses DailyExpense[]
}

model CreditSpend {
  id             Int           @id @default(autoincrement())
  amount         Float
  description    String
  type           String        @default("SPEND")
  date           DateTime      @default(now())
  cardId         Int
  dailyExpenseId Int?          @unique
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  creditCard     CreditCard    @relation(fields: [cardId], references: [id], onDelete: Cascade)
  dailyExpense   DailyExpense? @relation(fields: [dailyExpenseId], references: [id])
}

model Borrow {
  id         Int      @id @default(autoincrement())
  type       String
  personName String
  amount     Float
  status     String
  userId     Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Account {
  id            Int            @id @default(autoincrement())
  name          String
  type          String
  purpose       String         @default("GENERAL")
  balance       Float
  userId        Int
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  dailyExpenses DailyExpense[]
  fixedExpenses FixedExpense[]
  incomes       Income[]
}

model Saving {
  id            Int       @id @default(autoincrement())
  name          String
  targetAmount  Float
  currentAmount Float
  targetDate    DateTime?
  userId        Int
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model FinancialSnapshot {
  id           Int      @id @default(autoincrement())
  userId       Int
  month        String
  totalIncome  Float
  totalExpense Float
  savings      Float
  healthScore  Int
  riskLevel    String
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PasswordReset {
  id        Int      @id @default(autoincrement())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model Notification {
  id         Int      @id @default(autoincrement())
  userId     Int
  type       String
  title      String
  message    String
  read       Boolean  @default(false)
  actionLink String?
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Budget {
  id           Int      @id @default(autoincrement())
  userId       Int
  category     String
  monthlyLimit Float
  alertAt      Int      @default(80)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, category])
}

model RecurringExpense {
  id           Int      @id @default(autoincrement())
  userId       Int
  name         String
  amount       Float
  frequency    String
  dayOfMonth   Int?
  nextDue      DateTime
  reminderDays Int      @default(3)
  category     String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Investment {
  id             Int      @id @default(autoincrement())
  userId         Int
  name           String
  type           String
  investedAmount Float
  currentValue   Float
  returns        Float?
  platform       String?
  startDate      DateTime
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SystemSettings {
  id                 Int      @id @default(autoincrement())
  appName            String   @default("MoneyMind")
  smtpHost           String?
  smtpPort           Int?     @default(587)
  smtpUser           String?
  smtpPass           String?
  smtpSecure         Boolean  @default(false)
  maintenanceMode    Boolean  @default(false)
  allowRegistrations Boolean  @default(true)
  updatedAt          DateTime @updatedAt
}

model CategoryRule {
  id        Int      @id @default(autoincrement())
  userId    Int
  pattern   String   // Keyword to match (e.g. "Starbucks")
  category  String   // Target category (e.g. "Food")
  matchType String   @default("CONTAINS") // CONTAINS, EXACT, STARTS_WITH
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, pattern])
}
